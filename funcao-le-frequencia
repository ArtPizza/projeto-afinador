const int entrada = A3;

void setup() {
  pinMode(entrada, INPUT);
  Serial.begin(9600);
}

double fazMedia(long valor1, long valor2) {
  return (valor1 + valor2) / 2;
}

double leFrequencia() {
  float amplitudeInicial = 0; 
  bool leuAmplitudeInicial = false;
  float amplitudeAtual = 0;
  float amplitudeAnterior = 0; 
  float amplitudeBaseMax = 900;
  float amplitudeBaseMin = 100;
  //Os instantes sÃ£o em microssegundos
  long instanteAtual = 0;
  long instanteInicioSemiPeriodo = 0;
  long semiPeriodo1 = 0;
  long semiPeriodo2 = 0; 
  double frequencia = 0;
  bool comecou = false;
  
  while(!frequencia) {
    instanteAtual = micros();
    amplitudeAtual = analogRead(entrada);
    if(amplitudeAtual > amplitudeBaseMax)
      amplitudeAtual = 1023;
    else if(amplitudeAtual < amplitudeBaseMin)
      amplitudeAtual = 0;
    if(amplitudeAtual > 900 || amplitudeAtual < 100) {
      if(comecou) {
        if(amplitudeAtual != amplitudeAnterior) {
          if(!semiPeriodo1) {
            semiPeriodo1 = instanteAtual - instanteInicioSemiPeriodo;
            instanteInicioSemiPeriodo = instanteAtual;
          } else if(!semiPeriodo2) {
            semiPeriodo2 = instanteAtual - instanteInicioSemiPeriodo;
          }
          if(semiPeriodo2) {
            if((semiPeriodo2 - semiPeriodo1) > 100) {
              semiPeriodo1 = 0;
              semiPeriodo2 = 0;
            } else {
              double periodo = 2 * fazMedia(semiPeriodo1, semiPeriodo2);
              frequencia = 1 / (periodo * pow(10, -6));
            }
          }
        }
        amplitudeAnterior = amplitudeAtual;
      } else {
        if(!leuAmplitudeInicial) {
          amplitudeInicial = amplitudeAtual;
          leuAmplitudeInicial = true;
        }
        if(amplitudeAtual != amplitudeInicial && leuAmplitudeInicial) {
          comecou = true;
          amplitudeAnterior = amplitudeAtual;
          instanteInicioSemiPeriodo = instanteAtual;
        }
      }
    }
  }
  
  return frequencia;
}

void loop() {
  Serial.print("Frequencia lida: ");
  Serial.print(leFrequencia());
  Serial.println("Hz");
}
